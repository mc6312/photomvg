# PHOTOMVG

1. Сия программа является свободным ПО под лицензией [GPL v3](https://www.gnu.org/licenses/gpl.html).
2. Программа создана и дорабатывается автором исключительно ради собственных нужд
и в соответствии с его представлениями об эргономике и функциональности.
3. Автор всех видал в гробу и ничего никому не должен, кроме явно прописанного в GPL.
4. Несмотря на вышеуказанное, автор совершенно не против, если программа
подойдёт кому-то еще, кроме тех, под кем прогорит сиденье из-за пунктов
с 1 по 3.

## НАЗНАЧЕНИЕ

Поиск в каталогах-источниках изображений и видеофайлов, их перемещение
(или копирование) в каталог-приемник.

Подразумевается, что эта программа станет заменой графического режима
программы photomv, а разработка самой программы photomv будет, вероятно,
прекращена.

__Внимание!__ Это прототип программы. Почти ничего не работает, а что работает -
может быть изменено в любой момент. Большая часть описанных в данном
документе функций ещё не реализована!

### ЧТО ПЛАНИРУЕТСЯ

  1. Основная функциональность photomv: копирование или перемещение
     файлов с их переименованием по шаблону.
  2. В отличие от photomv, все параметры будут настраиваться из UI.
  3. Разделение процесса обработки файлов на три стадии (см. раздел
     "КАК РАБОТАЕТ")

## ЧТО ТРЕБУЕТ ДЛЯ РАБОТЫ

- Linux (или другую ОС, в которой заработает нижеперечисленное)
- Python 3.5 или новее
- GTK 3.20 или новее
- PyGI/PyGObject совместимой со всем этим версии

## КОНФИГУРАЦИЯ

Все параметры задаются в файле settings.ini (если он существует).

Программа ищет файл настроек в следующих каталогах (в порядке очерёдности):

1. Каталог, где расположена сама программа.
2. $HOME/.config/photomv/

При отсутствии файла настроек программа создает в каталоге из п.2 файл
со значениями по умолчанию, сообщает об этом и прекращает работу.

## КОМАНДНАЯ СТРОКА

Опции командной строки в текущей версии не поддерживаются.

## КАК РАБОТАЕТ

### 1. ПОИСК ФАЙЛОВ В КАТАЛОГАХ-ИСТОЧНИКАХ

Каталоги-источники обходятся рекурсивно, из файлов поддерживаемых форматов
извлекаются метаданные (в частности, поля EXIF).

В случае ошибок чтения файлов или ошибок в формате файлов выводится
предупреждение, и соответствующие файлы не обрабатываются.

Формат файлов определяется тупо и в лоб - по расширению.

На основе имён обнаруженных файлов и метаданных с помощью шаблонов (см.
соотв. разделы README) генерируется дерево новых каталогов и файлов.

### 2. ОТОБРАЖЕНИЕ ПОЛУЧЕННОГО ДЕРЕВА В UI

Файлы с одинаковыми именами, если таковые создаст шаблонизатор, будут
выделены.

Подобная ситуация может возникнуть при отсутствии
метаданных в файлах, на основе которых шаблонизатор генерирует
новые имена.

На этой стадии никакого копирования/перемещения файлов ещё
не производится, сгенерированное дерево каталогов и файлов -
фактически задание для следующей стадии.

Пользователь может просмотреть дерево файлов на предмет
неправильных имён и т.п., с возможностью переименования
файлов и изменения дерева каталогов вручную.

В случае отсутствия или успешного устранения ошибок пользователь
запускает выполнение следующей стадии, или завершает программу.

### 3. КОПИРОВАНИЕ ИЛИ ПЕРЕМЕЩЕНИЕ ФАЙЛОВ

Если в каталоге-приемнике уже есть файл с таким именем, поведение
программы зависит от параметра if-exists файла настроек.

## ФАЙЛ НАСТРОЕК

Файл настроек должен содержать две обязательные секции - __paths__ и
__options__, и может содержать необязательные - __templates__ и
__aliases__.

#### Секция paths

Параметры:

##### src-dirs

Должен быть указан один или несколько исходных каталогов, разделяемых
двоеточиями.

Если имя каталога начинается с символа "-", то этот каталог будет проигнорирован
при копировании или перемещении файлов.

В графическом режиме можно менять это состояние чекбоксами в списке исходных каталогов.

Пример: _/media/username/NIKON D7100/DCIM:/media/username/CANON 5D/DCIM_

В примере - пути к каталогам RAW-файлов примонтированных флэш-карт,
отформатированных средствами соотв. фотокамер.

##### dest-dir

Каталог назначения. Должен существовать на момент запуска программы.
Подкаталоги создаются при перемещении (копировании) файлов на основе
шаблонов.

Подкаталог __всегда__ создаётся внутри каталога назначения.

#### Секция options

Параметры:

##### if-exists

Задаёт поведение в ситуации, когда файл с таким же именем уже есть.

Значения:

- **s[kip]** - файл не копируется;
- **r[ename]** - к имени нового файла будет добавлен цифровой суффикс
вида "-NN" (режим по умолчанию);
- **o[verwrite]** - имеющийся файл будет перезаписан.

##### known-image-types, known-video-types

Эти необязательные параметры могут содержать списки расширений
файлов изображений и видеофайлов, которые должны обрабатываться
программой, в дополнение к внутренним спискам программы.

Расширения в списках разделяются пробелами. Точки вначале расширений
указывать можно, но не обязательно.

#### Секция templates

Необязательная секция; содержит шаблоны для новых имен файлов
и подкаталогов.

Названия параметров в этой секции:

- \* - в значении этого параметра указывается общий шаблон;
  если общий шаблон не задан, вместо него будет использоваться
  внутренний общий шаблон программы
- _имя модели камеры_ - если название этого параметра соответствует
значению поля Exif.Image.Model из исходного файла, применяется
индивидуальный шаблон камеры; сравнение значения из EXIF с названием
параметра - регистро-независимое

Если секция __templates__ отсутствует в файле настроек, ко всем файлам
применяется внутренний общий шаблон программы.

Имя подкаталога (подкаталогов) и новое имя файла задаётся в одной строке
шаблона (т.е. она может содержать символы-разделители путей).

#### Секция aliases

Необязательная секция; содержит сокращенные имена моделей камер
(для макроса ${alias} шаблонов).

Имена параметров в этой секции - названия моделей камер (как в
поле Exif.Image.Model), а значения - сокращённые имена.

Имена параметров - регистро-независимые.

Пример:

```
NIKON D70 = nd70
Canon EOS 5D Mark III = c5d3
```

## ШАБЛОНЫ

Шаблон представляет собой строку, содержащую макросы подстановки
(текст в фигурных скобках "{}"), разделители путей ("/") и/или
произвольный текст.

Символы, недопустимые в именах файлов, автоматически заменяются
символом подчёркивания ("\_").

Шаблон не должен содержать расширения - оно __всегда__ берётся из
исходного имени файла и приводится к нижнему регистру.

Символы разделения путей в начале шаблона (до первого макроса или текста)
удаляются.

Внутренний общий шаблон программы, используемый при отсутствии
других шаблонов:

```
{filename}
```

Т.е. сохраняется оригинальное имя файла.

### Макросы подстановки

Формат макроса - {имя}. Имена регистро-независимые, могут быть
указаны в полном или сокращенном виде. Пробелы между скобками и именами
шаблонов игнорируются.

Для вставки в шаблон символов фигурных скобок как есть - их следует
удваивать.

Значения полей берутся из EXIF исходного файла (если есть), из
имён и метаданных файлов в ФС (если есть). Отсутствующие
значения заменяются символом подчёркивания ("_").

#### {y[ear]}, {mon[th]}, {d[ay]}, {h[our]}, {m[inute]}

Год (с тысячелетием), месяц, день, час и минута создания файла
соответственно.

При наличии в файле EXIF - берутся оттуда, иначе - из даты последнего
изменения файла в ФС.

#### {model}

Название модели камеры (из Exif.Image.Model).

#### {a[lias]}

Сокращённое имя модели камеры.

Берётся соотв. значение из секции __aliases__ файла настроек.

#### {p[refix]}

Префикс исходного имени файла (например, для DSCN0666.NEF - "DSCN").

Символы "_" и "-" в начале и в конце префикса удаляются.

#### {n[umber]}

Номер из исходного имени файла (например, для DSCN0666.NEF - "0666").

#### {t[ype]}

Тип исходного файла в сокращённом виде - p (все изображения, в т.ч. RAW) или v (видео).

Определяется по расширению.

#### {l[ongtype]}

Тип исходного файла - raw (фотоснимки в формате RAW), photo (прочие
изображения) или video (видео).

Определяется по расширению.
